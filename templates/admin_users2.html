{% extends "admin_base.html" %}

{% block content %}
<main id="main" class="main">
    <h1 class="page-title">Admin - Manage Users</h1>

    <section>
        <table class="user-table" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Admin</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ 'Yes' if user.is_admin else 'No' }}</td>
                    <td>{{ user.status|capitalize }}</td>
                    <td class="action-cell">
                        <div class="action-dropdown" id="dropdown-{{ user.id }}">
                            <button class="action-btn" onclick="toggleDropdown(event, 'dropdown-{{ user.id }}')">...</button>
                            <div class="action-menu">
                                <a class="menu-item" href="{{ url_for('admin.view_user_businesses', user_id=user.id) }}">
                                    View Businesses
                                </a>

                                {% if user.status != 'suspended' %}
                                <a class="menu-item" href="{{ url_for('admin.suspend_user', user_id=user.id) }}">
                                    Suspend
                                </a>
                                {% else %}
                                <a class="menu-item" href="{{ url_for('admin.unsuspend_user', user_id=user.id) }}">
                                    Unsuspend
                                </a>
                                {% endif %}

                                <form action="{{ url_for('admin.delete_user', user_id=user.id) }}" method="post" class="menu-item">
                                    <button type="submit" onclick="confirmDelete(event)" style="border: none; background: none;">
                                        Delete User
                                    </button>
                                </form>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

    <script>
        function confirmDelete(event) {
            if (!confirm('Are you sure you want to delete this user?')) {
                event.preventDefault();
            }
        }

        function toggleDropdown(event, dropdownId) {
            event.stopPropagation();
            document.querySelectorAll('.action-menu').forEach(menu => {
                if (menu.parentElement.id !== dropdownId) {
                    menu.style.display = 'none';
                }
            });

            const dropdown = document.getElementById(dropdownId);
            const menu = dropdown.querySelector('.action-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        document.addEventListener('click', function (event) {
            document.querySelectorAll('.action-menu').forEach(menu => {
                if (!menu.contains(event.target) && !menu.previousElementSibling.contains(event.target)) {
                    menu.style.display = 'none';
                }
            });
        });
    </script>
</main>
{% endblock %}