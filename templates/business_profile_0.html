<!-- templates/business_profile.html -->
{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    
    <div class="row">

        <div class="col-lg-8 mx-auto">
            {% if business %}
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">{{ business.business_name }}</h4>
                    <span class="badge bg-{{ 'success' if business.status == 'active' else 'warning' if business.status == 'pending' else 'danger' }}">
                        {{ business.status_display }}
                    </span>
                </div>
                <div class="card-body">
                    <!-- Business Media -->
                    <div class="text-center mb-4">
                        {% if business.media_url %}
                            {% if business.media_type == 'image' %}
                            <img src="{{ business.media_url }}" class="img-fluid rounded" style="max-height: 300px" alt="{{ business.business_name }}">
                            {% else %}
                            <video controls class="img-fluid rounded" style="max-height: 300px">
                                <source src="{{ business.media_url }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            {% endif %}
                        {% else %}
                        <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 200px">
                            <i class="fas fa-store fa-4x text-muted"></i>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Business Details -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Details</h5>
                            <ul class="list-group list-group-flush">
                                {#<li class="list-group-item d-flex justify-content-between">
                                    <span>Category:</span>
                                    <span class="fw-bold">{{ business.category or 'Not specified' }}</span>
                                </li>#}
                                <li class="list-group-item">
                                    <span>Categories:</span>
                                    <div class="mt-2">
                                        {% for category in business_categories %}
                                        <span class="badge bg-primary me-1">{{ category.category_name }}</span>
                                        {% else %}
                                        <span class="fw-bold">Not specified</span>
                                        {% endfor %}
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Shop No:</span>
                                    <span class="fw-bold">{{ business.shop_no or 'Not specified' }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Block No:</span>
                                    <span class="fw-bold">{{ business.block_num or 'Not specified' }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Address:</span>
                                    <span class="fw-bold">{{ business.address or 'Not specified' }}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5 class="mb-3"><i class="fas fa-address-book me-2"></i>Contact</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Phone:</span>
                                    <span class="fw-bold">{{ business.phone_number or 'Not specified' }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Email:</span>
                                    <span class="fw-bold">{{ business.email or 'Not specified' }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Registered:</span>
                                    <span class="fw-bold">{{ business.created_at.strftime('%b %d, %Y') or ''}}</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <h5><i class="fas fa-align-left me-2"></i>Description</h5>
                        <div class="card card-body bg-light">
                            {{ business.description or 'No description provided.' }}
                        </div>
                    </div>

                    <!-- Social Links -->
                    <div class="mb-4">
                        <h5><i class="fas fa-share-alt me-2"></i>Social Links</h5>
                        <div class="d-flex flex-wrap gap-2">
                            {% if business.facebook_link %}
                            <a href="{{ business.facebook_link }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fab fa-facebook-f me-1"></i> Facebook
                            </a>
                            {% endif %}
                            {% if business.instagram_link %}
                            <a href="{{ business.instagram_link }}" target="_blank" class="btn btn-outline-danger btn-sm">
                                <i class="fab fa-instagram me-1"></i> Instagram
                            </a>
                            {% endif %}
                            {% if business.twitter_link %}
                            <a href="{{ business.twitter_link }}" target="_blank" class="btn btn-outline-info btn-sm">
                                <i class="fab fa-twitter me-1"></i> Twitter
                            </a>
                            {% endif %}
                            {% if business.website_url %}
                            <a href="{{ business.website_url }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-globe me-1"></i> Website
                            </a>
                            {% endif %}
                            {% if not business.facebook_link and not business.instagram_link and not business.twitter_link and not business.website_url %}
                            <span class="text-muted">No social links added</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Edit Section -->
                    <div id="edit" class="mt-5">
                        <h4 class="mb-4"><i class="fas fa-edit me-2"></i>Edit Business</h4>
                        <form method="POST" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="business_name" class="form-label">Business Name*</label>
                                    <input type="text" class="form-control" id="business_name" name="business_name" 
                                           value="{{ business.business_name }}" required>
                                </div>

                                {#<div class="col-md-6 mb-3">
                                    <label for="category" class="form-label">Category*</label>
                                    <input type="text" class="form-control" id="category" name="category" 
                                           value="{{ business.category }}" required>
                                </div>#}
                                <!-- With this multi-select dropdown -->
                        <div class="col-md-6 mb-3">
                            <label for="categories" class="form-label">Categories*</label>
                            <select class="form-select" id="categories" name="categories" multiple required>
                                {% for category in all_categories %}
                                <option value="{{ category.id }}" 
                                        {% if category.id in business_category_ids %}selected{% endif %}>
                                    {{ category.category_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple categories</div>
                        </div>

                            </div>
                            
                            <div class="mb-3">
                                                            <label for="description" class="form-label">Description*</label>
                                <textarea class="form-control" id="description" name="description" rows="3" required>{{ business.description }}</textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="phone_number" class="form-label">Phone Number*</label>
                                    <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                                           value="{{ business.phone_number }}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           value="{{ business.email }}">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="shop_no" class="form-label">Shop Number</label>
                                    <input type="text" class="form-control" id="shop_no" name="shop_no" 
                                           value="{{ business.shop_no }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="block_num" class="form-label">Block Number</label>
                                    <input type="text" class="form-control" id="block_num" name="block_num" 
                                           value="{{ business.block_num }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address" name="address" 
                                           value="{{ business.address }}">
                                </div>
                            </div>

                            <!-- Media Upload -->
                            <div class="mb-3">
                                <label for="business_media" class="form-label">Business Image/Video</label>
                                {#<input type="file" class="form-control" id="business_media" name="business_media" 
                                       accept="image/*,video/*">#}
                                
                                       {#<button type="submit" class="btn btn-outline-warning {{ 'active' if business.status == 'suspended' }}" 
                                        {{ 'disabled' if business.status == 'suspended' }}>
                                    <i class="fas fa-pause me-1"></i> Suspend
                                </button>#}
                                {% if business.status == 'suspended' %}
                                <p class="text-danger">Activate to change Business Ads Media By Subscribing to a plan or reaching out to Admin</p>
                                {% endif %}
                                <input type="file" class="form-control" id="business_media" {{ 'disabled' if business.status == 'suspended' }}
                                name="business_media" accept="image/*,video/*">
                                
                                
                                <div class="form-text">Upload a new image or video (max 5MB)</div>
                            </div>

                            <!-- Social Media Links -->
                            <div class="mb-4">
                                <h5 class="mb-3"><i class="fas fa-share-alt me-2"></i>Social Media Links</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="facebook_link" class="form-label">Facebook</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fab fa-facebook-f"></i></span>
                                            <input type="url" class="form-control" id="facebook_link" name="facebook_link" 
                                                   value="{{ business.facebook_link }}" placeholder="https://facebook.com/yourpage">
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="instagram_link" class="form-label">Instagram</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fab fa-instagram"></i></span>
                                            <input type="url" class="form-control" id="instagram_link" name="instagram_link" 
                                                   value="{{ business.instagram_link }}" placeholder="https://instagram.com/yourpage">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="twitter_link" class="form-label">Twitter</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fab fa-twitter"></i></span>
                                            <input type="url" class="form-control" id="twitter_link" name="twitter_link" 
                                                   value="{{ business.twitter_link }}" placeholder="https://twitter.com/yourpage">
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="website_url" class="form-label">Website</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-globe"></i></span>
                                            <input type="url" class="form-control" id="website_url" name="website_url" 
                                                   value="{{ business.website_url }}" placeholder="https://yourwebsite.com">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i> Save Changes
                                </button>
                                <a href="{{ url_for('user.profile') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Subscription Section -->
             
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-crown me-2"></i>Subscription & Status</h4>
                </div>
                <div class="card-body">

                    {% if business.is_subscribed and business.status != 'suspended' %}
                    <div class="alert alert-success">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="alert-heading"><i class="fas fa-check-circle me-2"></i>Active Subscription</h5>
                                <p class="mb-0">Your business is currently subscribed to our premium services.</p>
                            </div>
                            <span class="badge {{'bg-success' if business.status != 'suspended' else 'bg-warning'}}">{{business.status}}</span>
                        </div>
                    </div>

                    {% else %}
                    <div class="alert alert-warning">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="alert-heading"><i class="fas fa-exclamation-circle me-2"></i>No Active Subscription</h5>
                                <p class="mb-0">Upgrade to unlock premium features and better visibility.</p>
                            </div>
                            <span class="badge bg-warning text-dark">{{business.status}}</span>
                        </div>
                    </div>
                    {% endif %}

                    <h5 class="mt-4 mb-3">Available Plans</h5>
                    <div class="row">
                        {% for plan in subscription_plans %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 {{ 'border-success' if loop.first else 'border-primary' }}">
                                <div class="card-header {{ 'bg-success text-white' if loop.first else 'bg-primary text-white' }}">
                                    <h5 class="mb-0 text-center">{{ plan.plan_name }}</h5>
                                </div>
                                <div class="card-body">
                                    <h2 class="card-title pricing-card-title text-center mb-3">₦{{ plan.amount }}</h2>
                                    {#<ul class="list-unstyled">
                                        {% for feature in plan.features.split(',') %}
                                        <li><i class="fas fa-check text-success me-2"></i>{{ feature }}</li>
                                        {% endfor %}
                                    </ul>#}
                                </div>
                                <div class="card-footer bg-transparent text-center">
                                    <a href="https://paystack.com/pay/dunispay?amount={{ plan.amount }}" class="btn btn-sm {{ 'btn-success' if loop.first else 'btn-primary' }} w-100">
                                        Subscribe Now
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                    </div>
                </div>
            </div>

            <!-- Status Management -->
             {% if session.get('role') == 'admin': %}
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-cog me-2"></i>Business Status</h4>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h5>Current Status: 
                            <span class="badge bg-{{ 'success' if business.status == 'active' else 'warning' if business.status == 'pending' else 'danger' }}">
                                {{ business.status_display }}
                            </span>
                        </h5>
                        {% if business.status == 'pending' %}
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Your business is pending approval. Please wait for admin review or contact support.
                        </div>
                        {% endif %}
                    </div>

                    {#<div class="mb-3">
                        <h5>Change Status</h5>
                        <div class="btn-group w-100" role="group">
                            <form method="POST" action="{{ url_for('user.update_business_status', business_id=business.id) }}" class="w-100">
                                <input type="hidden" name="status" value="active">
                                <button type="submit" class="btn btn-outline-success {{ 'active' if business.status == 'active' }}" 
                                        {{ 'disabled' if business.status == 'active' }}>
                                    <i class="fas fa-check me-1"></i> Set Active
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('user.update_business_status', business_id=business.id) }}" class="w-100">
                                <input type="hidden" name="status" value="suspended">
                                <button type="submit" class="btn btn-outline-warning {{ 'active' if business.status == 'suspended' }}" 
                                        {{ 'disabled' if business.status == 'suspended' }}>
                                    <i class="fas fa-pause me-1"></i> Suspend
                                </button>
                            </form>

                            <!-- Subscription Toggle Switch -->
                            <form method="POST" action="{{ url_for('user.update_business_subscription', business_id=business.id) }}" class="mb-3">
                                <div class="form-check form-switch border-primarys">
                                    <input type="hidden" name="action" value="toggle_subscription">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                        id="subscriptionToggle" name="is_subscribed"
                                        {{ 'checked' if business.is_subscribed }} onchange="this.form.submit()"
                                        {{ 'disabled' if business.status == 'suspended' }}>
                                    <label class="form-check-label" for="subscriptionToggle">
                                        Activate Subscription
                                    </label>
                                </div>
                            </form>
                        </div>
                    </div>#}

                    <div class="mb-4">
    <h5 class="mb-3">Business Controls</h5>

    <!-- Status Buttons -->
    <div class="btn-group w-100 mb-3" role="group" aria-label="Change Status">
        <!-- Set Active -->
        <form method="POST" action="{{ url_for('user.update_business_status', business_id=business.id) }}">
            <input type="hidden" name="status" value="active">
            <button type="submit"
                    class="btn btn-outline-success {{ 'active' if business.status == 'active' }}"
                    {{ 'disabled' if business.status == 'active' }}>
                <i class="fas fa-check me-1"></i> Set Active
            </button>
        </form>

        <!-- Suspend -->
        <form method="POST" action="{{ url_for('user.update_business_status', business_id=business.id) }}">
            <input type="hidden" name="status" value="suspended">
            <button type="submit"
                    class="btn btn-outline-warning {{ 'active' if business.status == 'suspended' }}"
                    {{ 'disabled' if business.status == 'suspended' }}>
                <i class="fas fa-pause me-1"></i> Suspend
            </button>
        </form>
    </div>

    <!-- Subscription Toggle -->
    <form method="POST" action="{{ url_for('user.update_business_subscription', business_id=business.id) }}">


        <input type="hidden" name="action" value="toggle_subscription">

        <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch"
           id="subscriptionToggle" name="is_subscribed"
           {{ 'checked' if business.is_subscribed }}
           onchange="this.form.submit()"
           {{ 'disabled' if business.status == 'suspended' }}>
        <label class="form-check-label" for="subscriptionToggle">Activate Subscription</label>
        </div>

       {# <div class="form-check form-switch ps-0">
            <div class="border rounded p-2 d-flex  align-items-center justify-content-between">
                <div class="border rounded p-2 d-flex align-items-center justify-content-between">
    <label class="form-check-label m-0 me-7 fw-semibold" for="subscriptionToggle">
        Activate Subscription
    </label>

    <input class="form-check-input ms-3" type="checkbox" role="switch"
           id="subscriptionToggle" name="is_subscribed"
           {{ 'checked' if business.is_subscribed }}
           onchange="this.form.submit()"
           {{ 'disabled' if business.status == 'suspended' }}>
</div>#}

            </div>
        </div>
    </form>
</div>


                    <div class="alert alert-danger mt-4">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Danger Zone</h5>
                        <p>Deleting your business will remove all associated data permanently.</p>
                        <form method="POST" action="{{ url_for('user.delete_business', business_id=business.id) }}"
                              onsubmit="return confirm('Are you absolutely sure you want to delete this business? This cannot be undone.');">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash me-1"></i> Delete Business
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            {% endif %}

        </div>
        
    </div>

</div>

<script>
// Preview image when selected
document.getElementById('business_media').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const preview = document.createElement(file.type.includes('image') ? 'img' : 'video');
    preview.style.maxHeight = '300px';
    preview.className = 'img-fluid rounded mt-3';
    
    if (file.type.includes('image')) {
        preview.src = URL.createObjectURL(file);
    } else {
        preview.src = URL.createObjectURL(file);
        preview.controls = true;
    }
    
    const mediaContainer = document.querySelector('.text-center.mb-4');
    mediaContainer.innerHTML = '';
    mediaContainer.appendChild(preview);
});
</script>
{% endblock %}