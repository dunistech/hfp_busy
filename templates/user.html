{% extends "base.html" %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
  .text-primary {
    color: #7AB730 !important;
  }

  .form-check-input:checked {
    background-color: #7AB730;
    border-color: #7AB730;
  }

  .business-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
  }

  .status-badge {
    font-size: 0.875rem;
  }

  .table-custom {
    border-collapse: separate;
    border-spacing: 0;
  }

  .table-custom th {
    background-color: #f8f9fa;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
  }

  .table-custom td {
    vertical-align: middle;
  }

  .edit-link {
    color: #7AB730;
    text-decoration: none;
  }

  .edit-link:hover {
    color: #5a8a24;
    text-decoration: underline;
  }

  .social-link {
    color: #6c757d;
    font-size: 1.1rem;
    margin: 0 5px;
  }

  .social-link:hover {
    color: #7AB730;
  }

  .card-header {
    background-color: #7AB730;
    color: white;
    font-weight: 600;
  }

  .btn-success {
    background-color: #7AB730;
    border-color: #7AB730;
  }

  .btn-success:hover {
    background-color: #5a8a24;
    border-color: #5a8a24;
  }
</style>

<!-- Page Header -->
<div class="container my-5">
  <div class="row align-items-center mb-4">
    <div class="col">
      <h1 class="display-5 fw-bold text-center">My Businesses</h1>
      <p class="lead text-center text-muted">Manage and monitor your business listings</p>
    </div>
  </div>

  <!-- Add Business Button -->
  <div class="text-center mb-4">
    <a href="{{ url_for('user.add_business') }}" class="btn btn-success btn-lg">
      <i class="fas fa-plus me-2"></i>Add New Business
    </a>
  </div>

  <!-- Businesses Table -->
  {% if businesses %}
  <div class="card shadow-sm">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-building me-2"></i>Active Businesses</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-custom table-hover mb-0">
          <thead>
            <tr>
              <th scope="col">Media</th>
              <th scope="col">Business Name</th>
              <th scope="col">Category</th>
              <th scope="col">Address/Shop</th>
              <th scope="col">Phone</th>
              <th scope="col">Email</th>
              <th scope="col">Social Links</th>
              <th scope="col">Status</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for business in businesses %}
            <tr>
              <!-- Media Column -->
              <td>
                {% if business.media_type and business.media_url %}
                  {% if business.media_type == "image" %}
                    <img src="{{ business.media_url }}" class="rounded business-image" alt="{{ business.business_name }}">
                  {% elif business.media_type == "video" %}
                    <div class="position-relative">
                      <video class="rounded business-image" muted>
                        <source src="{{ business.media_url }}" type="video/mp4">
                      </video>
                      <i class="fas fa-play position-absolute top-50 start-50 translate-middle text-white"></i>
                    </div>
                  {% endif %}
                {% else %}
                  <img src="{{ url_for('static', filename='img/card.jpg') }}" class="rounded business-image" alt="Default">
                {% endif %}
              </td>

              <!-- Business Name -->
              <td>
                <div class="fw-bold">{{ business.business_name or 'Unnamed Business' }}</div>
                {% if business.description %}
                  <small class="text-muted d-block">{{ business.description[:50] }}{% if business.description|length > 50 %}...{% endif %}</small>
                {% endif %}
              </td>

              <!-- Category -->
              <td>
                <span class="badge bg-light text-dark">{{ business.category or 'Uncategorized' }}</span>
              </td>

              <!-- Address/Shop -->
              <td>
                <div class="small">
                  {% if business.address %}
                    <div><i class="fas fa-map-marker-alt me-1"></i>{{ business.address }}</div>
                  {% endif %}
                  {% if business.shop_no %}
                    <div><i class="fas fa-store me-1"></i>Shop: {{ business.shop_no }}</div>
                  {% endif %}
                  {% if not business.address and not business.shop_no %}
                    <span class="text-muted">Not specified</span>
                  {% endif %}
                </div>
              </td>

              <!-- Phone -->
              <td>
                {% if business.phone_number %}
                  <a href="tel:{{ business.phone_number }}" class="text-decoration-none">
                    <i class="fas fa-phone me-1"></i>{{ business.phone_number }}
                  </a>
                {% else %}
                  <span class="text-muted">Not provided</span>
                {% endif %}
              </td>

              <!-- Email -->
              <td>
                {% if business.email %}
                  <a href="mailto:{{ business.email }}" class="text-decoration-none">
                    <i class="fas fa-envelope me-1"></i>{{ business.email }}
                  </a>
                {% else %}
                  <span class="text-muted">Not provided</span>
                {% endif %}
              </td>

              <!-- Social Links -->
              <td>
                <div class="d-flex">
                  {% if business.facebook_link %}
                    <a href="{{ business.facebook_link }}" target="_blank" class="social-link" title="Facebook">
                      <i class="fab fa-facebook"></i>
                    </a>
                  {% endif %}
                  {% if business.instagram_link %}
                    <a href="{{ business.instagram_link }}" target="_blank" class="social-link" title="Instagram">
                      <i class="fab fa-instagram"></i>
                    </a>
                  {% endif %}
                  {% if business.twitter_link %}
                    <a href="{{ business.twitter_link }}" target="_blank" class="social-link" title="Twitter">
                      <i class="fab fa-twitter"></i>
                    </a>
                  {% endif %}
                  {% if business.linkedin_link %}
                    <a href="{{ business.linkedin_link }}" target="_blank" class="social-link" title="LinkedIn">
                      <i class="fab fa-linkedin"></i>
                    </a>
                  {% endif %}
                  {% if business.website_url %}
                    <a href="{{ business.website_url }}" target="_blank" class="social-link" title="Website">
                      <i class="fas fa-globe"></i>
                    </a>
                  {% endif %}
                  {% if not business.facebook_link and not business.instagram_link and not business.twitter_link and not business.linkedin_link and not business.website_url %}
                    <span class="text-muted small">None</span>
                  {% endif %}
                </div>
              </td>

              <!-- Subscription Status -->
              <td>
                {% if business.is_subscribed %}
                  <span class="badge bg-success status-badge">
                    <i class="fas fa-check-circle me-1"></i>Subscribed
                  </span>
                {% else %}
                  <span class="badge bg-danger status-badge">
                    <i class="fas fa-times-circle me-1"></i>Not Subscribed
                  </span>
                {% endif %}
              </td>

              <!-- Actions -->
              <td>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-cog"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a class="dropdown-item" href="{{ url_for('user.edit_business_media', business_id=business.id) }}">
                        <i class="fas fa-edit me-2"></i>Edit Details
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{{ url_for('user.edit_business_media', business_id=business.id) }}">
                        <i class="fas fa-camera me-2"></i>Edit Media
                      </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <a class="dropdown-item text-danger" href="{{ url_for('user.delete_business', business_id=business.id) }}" 
                         onclick="return confirm('Are you sure you want to delete this business?')">
                        <i class="fas fa-trash me-2"></i>Delete
                      </a>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer text-muted">
      <small>Total Businesses: {{ businesses|length }}</small>
    </div>
  </div>
  {% else %}
  <!-- No Businesses Message -->
  <div class="text-center py-5">
    <div class="mb-4">
      <i class="fas fa-building fa-4x text-muted"></i>
    </div>
    <h3 class="text-muted">No Businesses Found</h3>
    <p class="lead text-muted">You haven't registered any businesses yet.</p>
    <a href="{{ url_for('user.add_business') }}" class="btn btn-success btn-lg">
      <i class="fas fa-plus me-2"></i>Register Your First Business
    </a>
  </div>
  {% endif %}

  <!-- Pending Business Requests -->
  {% if pending_businesses %}
  <div class="mt-5">
    <div class="card shadow-sm">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Pending Business Requests</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-custom table-hover mb-0">
            <thead>
              <tr>
                <th scope="col">Business Name</th>
                <th scope="col">Shop No</th>
                <th scope="col">Phone</th>
                <th scope="col">Description</th>
                <th scope="col">Request Date</th>
                <th scope="col">Status</th>
              </tr>
            </thead>
            <tbody>
              {% for business in pending_businesses %}
              <tr>
                <td class="fw-bold">{{ business.business_name }}</td>
                <td>{{ business.shop_no or 'N/A' }}</td>
                <td>{{ business.phone_number or 'N/A' }}</td>
                <td>
                  <span title="{{ business.description }}">
                    {{ business.description[:50] }}{% if business.description|length > 50 %}...{% endif %}
                  </span>
                </td>
                <td>{{ business.created_at.strftime('%Y-%m-%d %H:%M') if business.created_at.else 'N/A' }}</td>
                <td>
                  <span class="badge bg-warning text-dark">
                    <i class="fas fa-hourglass-half me-1"></i>Pending Approval
                  </span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

</div>

<!-- Promotional Plans Section -->
<div class="container mt-5">
  <h2 class="display-6 text-center mb-4">Promotional Plans</h2>
  
  <div class="row justify-content-center" id="subscriptions">
    <!-- Plan Selection -->
    <div class="col-lg-8">
      <div class="mb-4 text-center">
        <div class="form-check form-check-inline">
          <input type="radio" id="standard" name="planType" value="standard" class="form-check-input" checked>
          <label for="standard" class="form-check-label fw-bold">Standard Plan</label>
        </div>
        <div class="form-check form-check-inline">
          <input type="radio" id="premium" name="planType" value="premium" class="form-check-input">
          <label for="premium" class="form-check-label fw-bold">Premium Plan</label>
        </div>
      </div>

      <!-- Standard Plan -->
      <div class="card shadow-sm" id="standard-plan">
        <div class="card-header">
          <h5 class="mb-0">Standard Plan</h5>
        </div>
        <div class="card-body">
          <p class="card-text">Choose your preferred payment frequency for the Standard Plan</p>
          
          <div class="mb-3">
            <label for="standard-payment" class="form-label fw-bold">Payment Frequency:</label>
            <select id="standard-payment" class="form-select" onchange="updatePricing('standard')">
              <option value="quarterly">Quarterly - ₦20,000</option>
              <option value="biannual">Bi-Annual - ₦26,000</option>
              <option value="annual">Annual - ₦50,000</option>
            </select>
          </div>

          <div id="standard-amount" class="text-success display-6 text-center mb-3"></div>
          
          <ul class="list-unstyled">
            <li><i class="fas fa-check text-success me-2"></i>Business listing</li>
            <li><i class="fas fa-check text-success me-2"></i>Basic analytics</li>
            <li><i class="fas fa-check text-success me-2"></i>Customer support</li>
          </ul>
        </div>
      </div>

      <!-- Premium Plan -->
      <div class="card shadow-sm d-none" id="premium-plan">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">Premium Plan</h5>
        </div>
        <div class="card-body">
          <p class="card-text">Enhanced features for growing businesses</p>
          
          <div class="mb-3">
            <label for="premium-payment" class="form-label fw-bold">Payment Frequency:</label>
            <select id="premium-payment" class="form-select" onchange="updatePricing('premium')" disabled>
              <option value="annual">Annual - ₦80,000</option>
            </select>
          </div>

          <div id="premium-amount" class="text-success display-6 text-center mb-3"></div>
          
          <ul class="list-unstyled">
            <li><i class="fas fa-check text-success me-2"></i>Everything in Standard</li>
            <li><i class="fas fa-check text-success me-2"></i>Priority listing</li>
            <li><i class="fas fa-check text-success me-2"></i>Advanced analytics</li>
            <li><i class="fas fa-check text-success me-2"></i>Premium support</li>
            <li><i class="fas fa-check text-success me-2"></i>Social media integration</li>
          </ul>
        </div>
      </div>

      <!-- Payment Button -->
      <div class="text-center mt-4">
        <a href="#" class="btn btn-success btn-lg" id="paystack-link">
          <i class="fas fa-credit-card me-2"></i>Proceed to Payment
        </a>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Update Pricing based on selected plan and payment frequency
    function updatePricing(planType) {
        const standardAmountElement = document.getElementById("standard-amount");
        const premiumAmountElement = document.getElementById("premium-amount");
        let amount = 0;

        if (planType === 'standard') {
            const standardPayment = document.getElementById("standard-payment").value;
            if (standardPayment === 'quarterly') {
                amount = 20000;
            } else if (standardPayment === 'biannual') {
                amount = 26000;
            } else if (standardPayment === 'annual') {
                amount = 50000;
            }
            standardAmountElement.innerHTML = `₦${amount.toLocaleString()}`;
        } else if (planType === 'premium') {
            amount = 80000;
            premiumAmountElement.innerHTML = `₦${amount.toLocaleString()}`;
        }

        // Update Paystack Payment link dynamically
        const paystackLink = document.getElementById("paystack-link");
        paystackLink.href = `https://paystack.com/pay/dunispay?amount=${amount}`;
    }

    // Handle Plan Change (Show/Hide plan cards)
    document.querySelectorAll('input[name="planType"]').forEach((radio) => {
        radio.addEventListener('change', function () {
            const standardPlan = document.getElementById('standard-plan');
            const premiumPlan = document.getElementById('premium-plan');
            
            if (this.value === 'standard') {
                standardPlan.classList.remove('d-none');
                premiumPlan.classList.add('d-none');
                document.getElementById('premium-payment').disabled = true;
                document.getElementById('standard-payment').disabled = false;
                updatePricing('standard');
            } else if (this.value === 'premium') {
                standardPlan.classList.add('d-none');
                premiumPlan.classList.remove('d-none');
                document.getElementById('premium-payment').disabled = false;
                document.getElementById('standard-payment').disabled = true;
                updatePricing('premium');
            }
        });
    });

    // Initialize the page with default pricing for Standard Plan
    document.addEventListener('DOMContentLoaded', function() {
        updatePricing('standard');
    });
</script>

{% endblock content %}